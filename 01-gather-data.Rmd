---
title: "Match Data"
output: 
  pdf_document: default
  html_notebook: default
---


```{bash, eval=FALSE}
cd /nfs/data/IHEC/RNAseq
echo "get ihec_metadata*" | sftp DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/readme
echo "get ihec_readme.pdf" | sftp DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/readme
sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/
find ~/ihec-incoming -printf "%p\t%CY-%Cm-%Cd %CH:%CM:%CS %CZ\n" > all_files.txt
fusermount -u ~/ihec-incoming
```

```{r}
write_chunked_files <- function(commands, n_chunks, name, folder) {
  if (length(commands) == 1)
    n_chunks <- 1
  if (n_chunks == 1)
    chunked_commands <- list(commands)
  else 
    chunked_commands <- split(commands, cut(seq_along(commands), n_chunks, labels = FALSE))
  lapply(seq(n_chunks), function(chunk_id){
    print(paste('writing', length(chunked_commands[[chunk_id]]), 'commands to file'))
    fileConn <- file(file.path(folder, sprintf("%s_%02d.txt", name, chunk_id)))
    writeLines(chunked_commands[[chunk_id]], fileConn)
    close(fileConn)
  })
}

determine_files_to_write <- function(files_to_download, prefix, dir_to_write, n_chunks = 1, remove = FALSE) {
  
  print(prefix)
  
  # make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
  sftp_files <- files_to_download
  local_files <- file.path(dir_to_write, basename(sftp_files[, filename]))
  
  still_to_download <- sftp_files[!(file.exists(local_files) & file.info(local_files)$ctime > sftp_files[, date]), filename]
  
  print(100*round(length(still_to_download)/length(local_files), 5))
  
  downloaded_files <- list.files(dir_to_write, full.names = TRUE)
  
  to_remove <- downloaded_files[!downloaded_files %in% local_files]
  if (remove) {
    print(paste('removing', length(to_remove), 'files'))
    file.remove(to_remove)
  } else {
    print(to_remove)
  }
  
  if (length(still_to_download) > 0) {
    get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', still_to_download, fixed = T))
    
    write_chunked_files(get_commands, n_chunks, prefix, dir_to_write)
  }
}
```



```{r}
all_files <- fread(file.path(data_dir, 'all_files.txt'), header = FALSE)
filename_date <- c('filename', 'date')
setnames(all_files, c('V1', 'V2'), filename_date)
all_files[, uuid:=gsub(pattern = '.*([[:alnum:]]{8}-[[:alnum:]]{4}-[[:alnum:]]{4}-[[:alnum:]]{4}-[[:alnum:]]{12}).*', '\\1', filename)]
```

## check RNA files

```{r}
# check the rna-seq metadata file first
rna_samples <- fread(file.path(data_dir, 'ihec_metadata_rna.csv'))
rna_samples <- rna_samples[uuid %in% all_files[, uuid]]
rna_samples[, epirr_id_wo_version := tstrsplit(epirr_id, '.', fixed = TRUE)[1]]
# rna_samples <- rna_samples[rna_seq_type == 'mRNA-Seq']

# now check the files that are actually available
isoform_files_downloaded <- list.files(rna_data_dir, pattern = '\\.isoforms\\.results$')
isoform_epirr_downloaded <- gsub("^.*?(IHECRE[0-9]{8}).*$", "\\1", isoform_files_downloaded)

# if (!identical(rna_samples[, sort(epirr_id_wo_version)], sort(isoform_epirr_downloaded))) {
#   print(paste('in metadata file but no isoform file:', paste(rna_samples[!epirr_id_wo_version %in% isoform_epirr_downloaded, epirr_id_wo_version], collapse = ', ')))
#   print(paste('isoform file but not in metadata file:', paste(isoform_files_downloaded[!isoform_epirr_downloaded %in% rna_samples[, epirr_id_wo_version]], collapse = ', ')))
# }
```

## check ChIP and WGBS files

```{r}
histone_samples <- fread(file.path(data_dir, 'ihec_metadata.csv'))
histone_samples <- histone_samples[uuid %in% all_files[, uuid]]
histone_samples[, epirr_id_wo_version := tstrsplit(epirr_id, '.', fixed = TRUE)[1]]

histone_samples_downloaded <- sort(unique(gsub("^.*?(IHECRE[0-9]{8}).*$", "\\1", list.files(chip_data_dir))))

# if (length(setdiff(histone_samples[, epirr_id_wo_version], histone_samples_available)) > 0) {
#   print(paste('in metadata file but no signal file:', paste(histone_samples[!epirr_id_wo_version %in% histone_samples_available, epirr_id_wo_version], collapse = ', ')))
#   print(paste('signal file but not in metadata file:', paste(histone_samples_available[!histone_samples_available %in% histone_samples[, epirr_id_wo_version]], collapse = ', ')))
# }
histone_marks <- c('H3K27ac', 'H3K27me3', 'H3K36me3', 'H3K4me1', 'H3K4me3', 'H3K9me3')
histones_w_all_marks <- histone_samples[, if(all(histone_marks %in% antibody)) .SD[antibody %in% histone_marks], by=.(epirr_id_wo_version)]

rna_samples_w_chip <- rna_samples[epirr_id_wo_version %in% histones_w_all_marks[, epirr_id_wo_version]]
rna_samples_w_chip <- rna_samples_w_chip[, if(.N > 1){.SD[rna_seq_type != 'total-RNA-Seq']}else{.SD}, by = epirr_id_wo_version]
```

```{r}
wgbs_samples <- fread(file.path(data_dir, 'ihec_metadata_wgbs.csv'))
wgbs_samples <- wgbs_samples[uuid %in% all_files[, uuid]]
wgbs_samples[, epirr_id_wo_version := tstrsplit(epirr_id, '.', fixed = TRUE)[1]]

wgbs_samples_downloaded <- sort(unique(gsub("^.*?(IHECRE[0-9]{8}).*$", "\\1", list.files(wgbs_data_dir, '\\.gembs_(pos|neg)\\.bw$'))))

# if (length(setdiff(wgbs_samples[, epirr_id_wo_version], wgbs_samples_available)) > 0) {
#   print(paste('in metadata file but no signal file:', paste(wgbs_samples[!epirr_id_wo_version %in% wgbs_samples_available, epirr_id_wo_version], collapse = ', ')))
#   print(paste('signal file but not in metadata file:', paste(wgbs_samples_available[!wgbs_samples_available %in% wgbs_samples[, epirr_id_wo_version]], collapse = ', ')))
# }

rna_samples_w_wgbs <- rna_samples[epirr_id_wo_version %in% wgbs_samples[, epirr_id_wo_version]]
rna_samples_w_wgbs <- rna_samples_w_wgbs[, if(.N > 1){.SD[rna_seq_type != 'total-RNA-Seq']}else{.SD}, by = epirr_id_wo_version]
```




### get RNA files

```{r}
epirr_ids_to_download <- intersect(rna_samples_w_chip[, sort(unique(epirr_id_wo_version))], rna_samples_w_wgbs[, sort(unique(epirr_id_wo_version))])
uuids_to_download <- rna_samples[epirr_id_wo_version %in% epirr_ids_to_download, .(epirr_id_wo_version, uuid, rna_seq_type)]
uuids_to_download <- uuids_to_download[, if(.N>1) .SD[rna_seq_type == 'mRNA-Seq'] else .SD, by=epirr_id_wo_version]

# also download files for comparison between total and mRNA-seq
uuids_total_mrna <- rna_samples[, if('mRNA-Seq' %in% rna_seq_type & 'total-RNA-Seq' %in% rna_seq_type).SD[rna_seq_type %in% c('total-RNA-Seq', 'mRNA-Seq'), .(uuid=uuid)], by=epirr_id_wo_version][, uuid]

rna_files_to_download <- all_files[uuid %in% c(uuids_to_download[, uuid], uuids_total_mrna) & endsWith(filename, '.isoforms.results')]

determine_files_to_write(files_to_download = rna_files_to_download,prefix = 'rna', dir_to_write = rna_data_dir, n_chunks = 1, remove = TRUE)

# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
# sftp_rna_files <- all_files[grep(rna_files_to_download, all_files[, filename]), .(filename, date)]
# local_rna_files <- file.path(rna_data_dir, basename(sftp_rna_files[, filename]))
# print(100*round(sum(file.exists(local_rna_files))/length(local_rna_files), 5))
# 
# downloaded_rna_files <- list.files(rna_data_dir, 'isoforms\\.results$', full.names = TRUE)
# # file.remove(downloaded_rna_files[!downloaded_rna_files %in% local_rna_files])
# 
# rna_get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', sftp_rna_files[!(file.exists(local_rna_files) & file.info(local_rna_files)$ctime > sftp_rna_files[, date]), filename], fixed = T))
# 
# write_chunked_files(rna_get_commands, 1, 'rna', rna_data_dir)
```

## download ChIP and WGBS files

```{r}
# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"

chip_files_to_download <- all_files[uuid %in% histones_w_all_marks[epirr_id_wo_version %in% epirr_ids_to_download, uuid] & endsWith(filename, '.fc.signal.bigwig')]

determine_files_to_write(files_to_download = chip_files_to_download, prefix = 'chip', dir_to_write = chip_data_dir, n_chunks = 1, remove = TRUE)
# 
# 
# sftp_chip_files <-  all_files[grep(chip_files_to_download, all_files[, filename]), .(filename, date)]
# local_chip_files <- file.path(chip_data_dir, basename(sftp_chip_files[, filename]))
# print(100*round(sum(file.exists(local_chip_files))/length(local_chip_files), 5))
# 
# downloaded_chip_files <- list.files(chip_data_dir, '\\.(fc\\.signal\\.bigwig|pval0\\.01\\.500K\\.bfilt\\.narrowPeak\\.gz)$', full.names = TRUE)
# # file.remove(downloaded_chip_files[!downloaded_chip_files %in% local_chip_files])
# 
# chip_get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', sftp_chip_files[!(file.exists(local_chip_files) & file.info(local_chip_files)$ctime > sftp_chip_files[, date]), filename], fixed = T))
# 
# write_chunked_files(chip_get_commands, 1, 'chip', chip_data_dir)

```


```{r}
# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
wgbs_files_to_download <- all_files[uuid %in% wgbs_samples[epirr_id_wo_version %in% epirr_ids_to_download, uuid] & endsWith(filename, '.bw')]

determine_files_to_write(files_to_download = wgbs_files_to_download, prefix = 'wgbs', dir_to_write = wgbs_data_dir, n_chunks = 1, remove = TRUE)

# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
# sftp_wgbs_files <- all_files[grep(wgbs_files_to_download, all_files[, filename]), .(filename, date)]
# local_wgbs_files <- file.path(wgbs_data_dir, basename(sftp_wgbs_files[, filename]))
# print(100*round(sum(file.exists(local_wgbs_files))/length(local_wgbs_files), 5))
# 
# downloaded_wgbs_files <- list.files(wgbs_data_dir, full.names = TRUE)
# # file.remove(downloaded_wgbs_files[!downloaded_wgbs_files %in% local_wgbs_files])
# 
# 
# wgbs_get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', sftp_wgbs_files[!(file.exists(local_wgbs_files) & file.info(local_wgbs_files)$ctime > sftp_wgbs_files[, date]), filename], fixed = T))
# 
# write_chunked_files(wgbs_get_commands, 1, 'wgbs', wgbs_data_dir)
```

here we need to download the files from the sftp

```{r, fig.width = 10}
sample_dt <-
  rbindlist(list(histones_w_all_marks[epirr_id_wo_version %in% epirr_ids_to_download, .(epirr_id_wo_version, uuid, antibody)],
       wgbs_samples[epirr_id_wo_version %in% epirr_ids_to_download, .(epirr_id_wo_version, uuid, antibody = 'wgbs')],
       rna_samples[uuid %in% uuids_to_download[, uuid], .(epirr_id_wo_version, uuid, antibody = rna_seq_type)]))

actually_downloaded_files <- unlist(sapply(c(rna_data_dir, chip_data_dir, wgbs_data_dir), list.files))

sample_dt[, actually_downloaded:=unlist(pbmclapply(uuid, function(uid) any(grepl(pattern = uid, x = actually_downloaded_files, fixed = TRUE))))]

ggplot(sample_dt, aes(x = reorder(epirr_id_wo_version, actually_downloaded, sum), y = reorder(antibody, antibody, length), fill = actually_downloaded)) + geom_tile()
```


```{r}
colVar <- function(x, na.rm = TRUE) {
  colMeans(x * x, na.rm = na.rm) - (colMeans(x, na.rm = na.rm)) ^ 2
}

pca_plots <-
  function(matrix,
           metadata,
           title = '',
           color_by = 'annotation',
           shape_by = 'project',
           label = 'annotation',
           na.omit = FALSE) {
    if (na.omit){
      matrix <- matrix[, colSums(is.na(matrix)) == 0, drop=FALSE]
    } else {
      # set NA to 0
      matrix[is.na(matrix)] <- 0
    }
    
    # filter out cols without variance
    matrix <- matrix[, colVar(matrix) != 0, drop = FALSE]
    
    # perform PCA
    pca <- prcomp(matrix, center = TRUE, scale = TRUE)
    
    # compute explained variance of PCs
    var_explained_tpm = 100 * pca$sdev ^ 2 / sum(pca$sdev ^ 2)
    
    return(
      list(
        pca = pca,
        dimred = ggplot2::autoplot(
          pca,
          data = metadata,
          colour = color_by,
          shape = shape_by
        ) + labs(title = paste('PCA:', title)) + geom_text_repel(
          aes(label = get(label)),
          min.segment.length = 0,
          max.overlaps = 5
        ),
        scree = qplot(seq.int(var_explained_tpm), var_explained_tpm) +
          geom_line() +
          xlab("Principal Component") +
          ylab("Percent Variance Explained") +
          ggtitle(paste("Variance explained:", title))
      )
    )
  }
```

Load Metadata:

```{r}
# load metadata
metadata <- data.table::fread('IHEC_metadata_harmonization.v0.7.csv')
metadata[, EpiRR_no_version := data.table::tstrsplit(EpiRR, '.', fixed = TRUE)[1]]
metadata[, annotation := cell_type]
metadata[biomaterial_type == 'primary tissue', annotation := tissue_type]
metadata[biomaterial_type == 'cell line', annotation := line]
metadata[annotation == "CD34-positive, CD38-positive common myeloid progenitor OR CD34-positive, CD38-positive common lymphoid progenitor", annotation := "CD34-positive, CD38-positive common progenitor"]
```

Load Isoform Quantifications:

```{r}
# rna_metadata <- fread(file.path(data_dir, 'ihec_metadata_rna.csv'))
# rna_metadata[, EpiRR_no_version := tstrsplit(epirr_id, '.', fixed = TRUE)[1]]
# multiple_RNAs <- rna_metadata[, if(.N > 1) .(uuid, rna_seq_type), by=EpiRR_no_version]

isoform_files <- list.files(rna_data_dir, pattern = paste0(paste(uuids_to_download[, uuid], collapse = '|'),'\\.isoforms\\.results$'), full.names = T)
cols_to_keep <- c('transcript_id', 'gene_id', 'TPM')
iso_quants_list <- pbmcapply::pbmclapply(isoform_files, data.table::fread, stringsAsFactor=TRUE, fill = TRUE, select = cols_to_keep)
names(iso_quants_list) <- isoform_files
isoform_quants <- data.table::rbindlist(iso_quants_list, idcol = 'EpiRR')
file2id <- gsub("^.*?(IHECRE[0-9]{8}).*$", "\\1", isoform_files)
names(file2id) <- isoform_files
isoform_quants[, EpiRR_no_version := as.factor(file2id[isoform_quants[, EpiRR]])]
isoform_quants[, EpiRR:=NULL]

suppressWarnings(dir.create('suppa_analysis/'))

gene_quants <- isoform_quants[, .(gene_tpm = sum(TPM, na.rm = TRUE)), by = c('EpiRR_no_version', 'gene_id')]
gene_expr_file <- 'suppa_analysis/gene_expressions.rds'
# if (!file.exists(gene_expr_file)) {
  saveRDS(gene_quants, gene_expr_file)
# }

# bring tpms to wide format
tpm_dt <- data.table::dcast(isoform_quants, transcript_id ~ EpiRR_no_version, value.var = 'TPM', fill = 0)


# remove id column
# tpm_matrix <- as.matrix(tpm_dt[, -'EpiRR_no_version'])

# write files for SUPPA2
# rownames(tpm_matrix) <- tpm_dt[, EpiRR_no_version]
# tpm_matrix[is.na(tpm_matrix)] <- 0
suppa_expr_filename <- 'suppa_analysis/tpm_expressions.tsv'
# if (!file.exists(suppa_expr_filename)) {
  fileConn<-file(suppa_expr_filename)
  writeLines(paste(names(tpm_dt)[-1], collapse = '\t'), fileConn)
  close(fileConn)
  fwrite(tpm_dt, suppa_expr_filename, sep='\t', append = TRUE)
  # write.table(t(tpm_matrix), file=suppa_expr_filename, sep="\t", quote = FALSE)
# }

# filter metadata
metadata <- metadata[EpiRR_no_version %in% names(tpm_dt)[-1]]
# remove the two outliers
metadata_filtered <- metadata[cell_type != 'sperm']
save.image('pca.rda')
```
