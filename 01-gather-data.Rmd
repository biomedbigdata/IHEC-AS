---
title: "Match Data"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---


```{bash, eval=FALSE}
cd /nfs/data/IHEC/RNAseq
echo "get epiatlas_metadata*" | sftp DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/readme
echo "get IHEC*" | sftp DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/readme
#sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/
find ~/ihec-incoming -printf "%p\t%CY-%Cm-%Cd %CH:%CM:%CS %CZ\n" > all_files.txt
fusermount -u ~/ihec-incoming
```

```{r}
write_chunked_files <- function(commands, n_chunks, name, folder) {
  if (length(commands) == 1)
    n_chunks <- 1
  if (n_chunks == 1)
    chunked_commands <- list(commands)
  else 
    chunked_commands <- split(commands, cut(seq_along(commands), n_chunks, labels = FALSE))
  lapply(seq(n_chunks), function(chunk_id){
    print(paste('writing', length(chunked_commands[[chunk_id]]), 'commands to file'))
    fileConn <- file(file.path(folder, sprintf("%s_%02d.txt", name, chunk_id)))
    writeLines(chunked_commands[[chunk_id]], fileConn)
    close(fileConn)
  })
}

determine_files_to_write <- function(files_to_download, prefix, dir_to_write, n_chunks = 1, remove = FALSE) {
  
  print(prefix)
  
  # make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
  sftp_files <- rbindlist(list(files_to_download, files_to_download[, .(filename=paste0(filename, ".md5"), date=date)]))
  
  local_files <- file.path(dir_to_write, basename(sftp_files[, filename]))
  still_to_download <- sftp_files[!(file.exists(local_files) & as.Date(file.info(local_files)$ctime) > as.Date(sftp_files[, date], format="%m-%d-%Y")), filename]
  
  print(100*round(length(still_to_download)/length(local_files), 5))
  
  downloaded_files <- list.files(dir_to_write, full.names = TRUE)
  
  to_remove <- downloaded_files[!downloaded_files %in% local_files]
  if (remove) {
    print(paste('removing', length(to_remove), 'files'))
    file.remove(to_remove)
  } else {
    print(to_remove)
  }
  
  if (length(still_to_download) > 0) {
    get_commands <- paste('get', file.path("/IHEC", still_to_download))
    
    write_chunked_files(get_commands, n_chunks, prefix, dir_to_write)
  }
}
```



```{r}
all_files <- fread(file.path(data_dir, 'epiatlas_metadata.csv'))
# all_files[, epirr_id_without_version := tstrsplit(epirr_id, '.', fixed = TRUE)[1]]
# filename_date <- c('filename', 'date')
# setnames(all_files, c('V1', 'V2'), filename_date)
# all_files[, uuid:=gsub(pattern = '.*([[:alnum:]]{8}-[[:alnum:]]{4}-[[:alnum:]]{4}-[[:alnum:]]{4}-[[:alnum:]]{12}).*', '\\1', filename)]
```

## check ChIP and WGBS files

```{r}
histone_marks <- c('H3K27ac', 'H3K27me3', 'H3K36me3', 'H3K4me1', 'H3K4me3', 'H3K9me3')
histones_w_all_marks <- all_files[assay_type == "ChIP-Seq", if(all(histone_marks %in% experiment_type)) .SD[experiment_type %in% histone_marks], by=.(epirr_id_without_version)]

# find rna samples with all histone marks
rna_samples_w_chip <- all_files[assay_type == "RNA-Seq" & epirr_id_without_version %in% histones_w_all_marks[, epirr_id_without_version]]
# for files with both total and mRNA-Seq used mRNA-Seq 
rna_samples_w_chip <- rna_samples_w_chip[, if(.N > 1){.SD[experiment_type != 'total-RNA-Seq']}else{.SD}, by = epirr_id_without_version]
```

```{r}
# find rna samples with methylation data
rna_samples_w_wgbs <- all_files[assay_type == "RNA-Seq" & epirr_id_without_version %in% all_files[assay_type == "WGBS", epirr_id_without_version]]
# for files with both total and mRNA-Seq used mRNA-Seq 
rna_samples_w_wgbs <- rna_samples_w_wgbs[, if(.N > 1){.SD[experiment_type != 'total-RNA-Seq']}else{.SD}, by = epirr_id_without_version]
```




### get RNA files

```{r}
epirr_ids_to_download <- intersect(rna_samples_w_chip[, sort(unique(epirr_id_without_version))], rna_samples_w_wgbs[, sort(unique(epirr_id_without_version))])
uuids_to_download <- all_files[assay_type == "RNA-Seq" & epirr_id_without_version %in% epirr_ids_to_download, .(epirr_id_without_version, uuid, experiment_type)]
uuids_to_download <- uuids_to_download[, if(.N>1) .SD[experiment_type == 'mRNA-Seq'] else .SD, by=epirr_id_without_version]

# also download files for comparison between total and mRNA-seq
uuids_total_mrna <- all_files[assay_type == "RNA-Seq", if('mRNA-Seq' %in% experiment_type & 'total-RNA-Seq' %in% experiment_type).SD[experiment_type %in% c('total-RNA-Seq', 'mRNA-Seq'), .(uuid=uuid)], by=epirr_id_without_version][, uuid]

isoform_files_to_download <- all_files[uuid %in% unique(c(uuids_to_download[, uuid], uuids_total_mrna)), .(filename=sub("*", "isoforms.results", data_file_path, fixed=TRUE), date=upload_date)]
# download all, in order to create size normalized files
isoform_files_to_download <- all_files[assay_type == "RNA-Seq", .(filename=sub("*", "isoforms.results", data_file_path, fixed=TRUE), date=upload_date)]
# download all, in order to create size normalized files
gene_files_to_download <- all_files[assay_type == "RNA-Seq", .(filename=sub("*", "genes.results", data_file_path, fixed=TRUE), date=upload_date)]


determine_files_to_write(files_to_download = rbindlist(list(isoform_files_to_download, gene_files_to_download)), prefix = 'rna', dir_to_write = rna_data_dir, n_chunks = 1)#, remove = TRUE)

# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
# sftp_rna_files <- all_files[grep(rna_files_to_download, all_files[, filename]), .(filename, date)]
# local_rna_files <- file.path(rna_data_dir, basename(sftp_rna_files[, filename]))
# print(100*round(sum(file.exists(local_rna_files))/length(local_rna_files), 5))
# 
# downloaded_rna_files <- list.files(rna_data_dir, 'isoforms\\.results$', full.names = TRUE)
# # file.remove(downloaded_rna_files[!downloaded_rna_files %in% local_rna_files])
# 
# rna_get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', sftp_rna_files[!(file.exists(local_rna_files) & file.info(local_rna_files)$ctime > sftp_rna_files[, date]), filename], fixed = T))
# 
# write_chunked_files(rna_get_commands, 1, 'rna', rna_data_dir)
```

## download ChIP and WGBS files

```{r}
# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"

chip_files_to_download <- histones_w_all_marks[epirr_id_without_version %in% epirr_ids_to_download, .(filename=sub("*", "fc.signal.bigwig", data_file_path, fixed=TRUE), date=upload_date)]

determine_files_to_write(files_to_download = chip_files_to_download, prefix = 'chip', dir_to_write = chip_data_dir, n_chunks = 1)#, remove = TRUE)
# 
# 
# sftp_chip_files <-  all_files[grep(chip_files_to_download, all_files[, filename]), .(filename, date)]
# local_chip_files <- file.path(chip_data_dir, basename(sftp_chip_files[, filename]))
# print(100*round(sum(file.exists(local_chip_files))/length(local_chip_files), 5))
# 
# downloaded_chip_files <- list.files(chip_data_dir, '\\.(fc\\.signal\\.bigwig|pval0\\.01\\.500K\\.bfilt\\.narrowPeak\\.gz)$', full.names = TRUE)
# # file.remove(downloaded_chip_files[!downloaded_chip_files %in% local_chip_files])
# 
# chip_get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', sftp_chip_files[!(file.exists(local_chip_files) & file.info(local_chip_files)$ctime > sftp_chip_files[, date]), filename], fixed = T))
# 
# write_chunked_files(chip_get_commands, 1, 'chip', chip_data_dir)

```


```{r}
# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
wgbs_files_to_download <- all_files[assay_type == "WGBS" & uuid %in% all_files[epirr_id_without_version %in% epirr_ids_to_download, uuid]]
wgbs_files_to_download <- rbindlist(list(wgbs_files_to_download[, .(filename=sub("*", "gembs_neg.bw", data_file_path, fixed=TRUE), date=upload_date)], 
                                         wgbs_files_to_download[, .(filename=sub("*", "gembs_pos.bw", data_file_path, fixed=TRUE), date=upload_date)]))

determine_files_to_write(files_to_download = wgbs_files_to_download, prefix = 'wgbs', dir_to_write = wgbs_data_dir, n_chunks = 1)#, remove = TRUE)

# for alex:
# meta <- fread('IHEC_metadata_harmonization.v1.0.extended.csv')
# meta[, epirr_id_without_version := tstrsplit(EpiRR, '.', fixed = TRUE)[1]]
# all_files[uuid %in% wgbs_samples[epirr_id_without_version %in% meta[epirr_id_without_version %in% wgbs_samples[, epirr_id_without_version] & harmonized_sample_ontology_intermediate == 'monocyte' & harmonized_sample_disease_intermediate == 'None', epirr_id_without_version], uuid]]

# determine_files_to_write(all_files[uuid %in% wgbs_samples[epirr_id_without_version %in% meta[epirr_id_without_version %in% wgbs_samples[, epirr_id_without_version] & harmonized_sample_ontology_intermediate == 'monocyte' & harmonized_sample_disease_intermediate == 'None', epirr_id_without_version], uuid] & endsWith(filename, 'cpg.bed.gz')], prefix = 'alex_wgbs', dir_to_write = wgbs_data_dir, n_chunks = 4)

# make sure you ran "sshfs DATA-545_qmanz@sftp.bcgsc.ca:/IHEC/incoming/ /nfs/home/students/ga89koc/ihec-incoming/"
# sftp_wgbs_files <- all_files[grep(wgbs_files_to_download, all_files[, filename]), .(filename, date)]
# local_wgbs_files <- file.path(wgbs_data_dir, basename(sftp_wgbs_files[, filename]))
# print(100*round(sum(file.exists(local_wgbs_files))/length(local_wgbs_files), 5))
# 
# downloaded_wgbs_files <- list.files(wgbs_data_dir, full.names = TRUE)
# # file.remove(downloaded_wgbs_files[!downloaded_wgbs_files %in% local_wgbs_files])
# 
# 
# wgbs_get_commands <- paste('get', sub('/nfs/home/students/ga89koc/ihec-incoming', '/IHEC/incoming', sftp_wgbs_files[!(file.exists(local_wgbs_files) & file.info(local_wgbs_files)$ctime > sftp_wgbs_files[, date]), filename], fixed = T))
# 
# write_chunked_files(wgbs_get_commands, 1, 'wgbs', wgbs_data_dir)
```

here we need to download the files from the sftp

```{r, fig.width = 10}
sample_dt <-
rbindlist(list(histones_w_all_marks[epirr_id_without_version %in% epirr_ids_to_download],
       all_files[assay_type == "WGBS" & uuid %in% all_files[epirr_id_without_version %in% epirr_ids_to_download, uuid]],
       all_files[uuid %in% uuids_to_download[, uuid]]), use.names = TRUE)

actually_downloaded_files <- unlist(sapply(c(rna_data_dir, chip_data_dir, wgbs_data_dir), list.files))
actually_downloaded_files <- actually_downloaded_files[!endsWith(actually_downloaded_files, ".md5")]

sample_dt[, actually_downloaded:=unlist(pbmclapply(uuid, function(uid) any(grepl(pattern = uid, x = actually_downloaded_files, fixed = TRUE))))]
sample_dt[, experiment_type:=factor(experiment_type, levels = c("total-RNA-Seq", "mRNA-Seq", "PBAT", "standard", "H3K27ac", "H3K27me3", "H3K36me3", "H3K4me1", "H3K4me3", "H3K9me3"))]

ggplot(sample_dt, aes(x = reorder(epirr_id_without_version, actually_downloaded, sum), y = experiment_type, fill = actually_downloaded)) + geom_tile()
```

Load Metadata:

```{r}
# load metadata
metadata <- data.table::fread('IHEC_metadata_harmonization.v1.0.extended.csv')
metadata[, EpiRR_no_version := data.table::tstrsplit(EpiRR, '.', fixed = TRUE)[1]]
```

Load Isoform Quantifications:

```{r}
# rna_metadata <- fread(file.path(data_dir, 'ihec_metadata_rna.csv'))
# rna_metadata[, EpiRR_no_version := tstrsplit(epirr_id, '.', fixed = TRUE)[1]]
# multiple_RNAs <- rna_metadata[, if(.N > 1) .(uuid, rna_seq_type), by=EpiRR_no_version]

isoform_files <- list.files(rna_data_dir, pattern = paste0('(', paste(uuids_to_download[, uuid], collapse = '|'), ')','\\.isoforms\\.results$'), full.names = T)
cols_to_keep <- c('transcript_id', 'gene_id', 'TPM')
iso_quants_list <- pbmcapply::pbmclapply(isoform_files, data.table::fread, stringsAsFactor=TRUE, fill = TRUE, select = cols_to_keep)
names(iso_quants_list) <- isoform_files
isoform_quants <- data.table::rbindlist(iso_quants_list, idcol = 'EpiRR')
file2id <- gsub("^.*?(IHECRE[0-9]{8}).*$", "\\1", isoform_files)
names(file2id) <- isoform_files
isoform_quants[, EpiRR_no_version := as.factor(file2id[isoform_quants[, EpiRR]])]
isoform_quants[, EpiRR:=NULL]

suppressWarnings(dir.create('suppa_analysis/'))

gene_quants <- isoform_quants[, .(gene_tpm = sum(TPM, na.rm = TRUE)), by = c('EpiRR_no_version', 'gene_id')]
gene_expr_file <- 'suppa_analysis/gene_expressions.rds'
# if (!file.exists(gene_expr_file)) {
  saveRDS(gene_quants, gene_expr_file)
# }

# bring tpms to wide format
tpm_dt <- data.table::dcast(isoform_quants, transcript_id ~ EpiRR_no_version, value.var = 'TPM', fill = 0)


# remove id column
# tpm_matrix <- as.matrix(tpm_dt[, -'EpiRR_no_version'])

# write files for SUPPA2
# rownames(tpm_matrix) <- tpm_dt[, EpiRR_no_version]
# tpm_matrix[is.na(tpm_matrix)] <- 0
suppa_expr_filename <- 'suppa_analysis/tpm_expressions.tsv'
# if (!file.exists(suppa_expr_filename)) {
  fileConn<-file(suppa_expr_filename)
  writeLines(paste(names(tpm_dt)[-1], collapse = '\t'), fileConn)
  close(fileConn)
  fwrite(tpm_dt, suppa_expr_filename, sep='\t', append = TRUE)
  # write.table(t(tpm_matrix), file=suppa_expr_filename, sep="\t", quote = FALSE)
# }

# filter metadata
metadata <- metadata[EpiRR_no_version %in% names(tpm_dt)[-1]]
# remove the two outliers
# metadata_filtered <- metadata[cell_type != 'sperm']
save.image('pca.rda')
```
