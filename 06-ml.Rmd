---
title: "ML"
output: pdf_document
---

```{r}
library(ggplot2)
library(glmnet)
glmnet.control(itrace = 1)
all_models <- sapply(to_analyze, function(event) readRDS(paste(event, 'models.rds', sep = '_')))
```


# overall model

```{r, eval=FALSE}
aggregated_dt <- readRDS('aggregated_dt.rds')
aggregation <- 'max'
response <- 'PSI'
```


```{r, eval=FALSE}
if (!all(file.exists(paste(to_analyze, 'models.rds', sep = '_'))))
source('06-ml.R')
```

# check models

```{r, fig.width=16, fig.height=11}
rank_dt <- rbindlist(sapply(to_analyze, function(this_event){
  models <- all_models[, this_event]
  as_dt <- rbindlist(sapply(names(models), function(cvfit_name) {
    cvfits <- models[[cvfit_name]]$cvfit
    rbindlist(sapply(names(cvfits), function(alpha) {
      cvfit <- cvfits[[alpha]]
      if (alpha == 'OLS') {
        coefs <- as.matrix(coef(cvfit))
      } else {
        coefs <- coef(cvfit, s = my_lambda)
        # plot(cvfit, main=paste(this_event, cvfit_name, alpha))
      }
      data.table(feature = rownames(coefs), coefs = coefs[, 1])
    }, simplify = FALSE), idcol = 'alpha')
  }, simplify = FALSE), idcol = 'model')
  # as_dt <- melt(dcast(as_dt, model + alpha ~ feature, value.var = 'coefs'), id.vars = c('model', 'alpha'), variable.name = 'feature', value.name = 'coefs')
  # as_dt[, model:=sub('no_enhancer', 'noEnhancer', model, fixed = TRUE)]
  # as_dt[, model:=sub('enhancer_stripped', 'enhancerStripped', model, fixed = TRUE)]
  as_dt[, model:=gsub('nocCRE', 'wo/ cCRE', model, fixed = TRUE)]
  as_dt[, c('PSI Variance', 'dat_expl_resp'):=tstrsplit(model, '.', fixed=TRUE)]
  as_dt[, `PSI Variance`:=tstrsplit(`PSI Variance`, '_', fixed=TRUE, keep = 1)]
  as_dt[, c('dataset', 'explanatory', 'response'):=tstrsplit(dat_expl_resp, '_', fixed=TRUE)]
  # as_dt[, coef_rank:=rank(-coefs, na.last = 'keep'), by=model]
}, simplify = FALSE), idcol = 'Event Type')
split_features(rank_dt, 'feature')
rank_dt[, region:=sub('upstream', 'Upstream', region, fixed = TRUE)]
rank_dt[, region:=sub('downstream', 'Downstream', region, fixed = TRUE)]
rank_dt[, region:=gsub('[_,]', '\n', region)]
rank_dt[, region := factor(
  region,
  levels =
    c(
      unique(region)[startsWith(unique(region), 'Upstream')],
      unique(region)[startsWith(unique(region), 'RI')],
      unique(region)[startsWith(unique(region), 'SE')],
      unique(region)[startsWith(unique(region), 'Downstream')],
      unique(region)[startsWith(unique(region), 'Gene')],
      unique(region)[startsWith(unique(region), 'PLS')],
      unique(region)[startsWith(unique(region), 'DNase-H3K4me3')],
      unique(region)[startsWith(unique(region), 'pELS')],
      unique(region)[startsWith(unique(region), 'dELS')],
      unique(region)[startsWith(unique(region), 'CTCF-only')]
    )
)]
rank_dt[, mark:=sub('gene_expression', 'Gene_Expression', mark)]
rank_dt[, mark:=gsub('[_,]', '\n', mark)]
rank_dt[, mark:=sub('wgbs', 'DNAm', mark)]
rank_dt[, mark:=sub('width', 'Width', mark)]
rank_dt[, mark:=sub('distance', 'Distance', mark)]
rank_dt[, mark := factor(
  mark,
  levels =
    c('(Intercept)', 'ID', 'Gene\nExpression', 'Distance\nTSS', 'Distance\nTES', 'Width', 'DNAm', 'H3K36me3', 'H3K4me1', 'H3K4me3', 'H3K27me3', 'H3K27ac', 'H3K9me3')
)]

rank_dt[, 'Samples, Features':= paste(dataset, explanatory, sep = ', ')]
```


```{r, fig.width=16, fig.height=11}
my_colors <- rev(c("#CC79A7", "#009E73", "#999999"))

for (this_event in to_analyze) {
  print(ggplot(rank_dt[feature != '(Intercept)' & this_event == `Event Type` & alpha == 'OLS' & region != 'Gene-Wide' & mark != 'Width'], aes(x = `Samples, Features`, y = coefs, color=`PSI Variance`, shape = `Samples, Features`, size = abs(coefs))) + facet_grid(mark ~ region) + geom_hline(yintercept = 0) + geom_point() + theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())#element_text(angle = 45, hjust=1))
        + labs(y = 'Coefficient', size = 'Absolute Coefficient') + scale_shape_manual(values = LETTERS) + theme(legend.position = 'bottom') + scale_color_manual(values = my_colors))
  ggsave(filename = file.path(plot_dir, paste0('coef_', this_event, '.pdf')), width = 14, height = 8)
  print(ggplot(rank_dt[feature != '(Intercept)' & this_event == `Event Type` & alpha == 'OLS' & (region == 'Gene-Wide' | mark ==  'Width')], aes(x = `Samples, Features`, y = coefs, color=`PSI Variance`, shape = `Samples, Features`, size = abs(coefs))) + facet_wrap(~ region + mark, nrow = 2) + geom_hline(yintercept = 0) + geom_point() + theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())#element_text(angle = 45, hjust=1))
        + labs(y = 'Coefficient', size = 'Absolute Coefficient') + scale_shape_manual(values = LETTERS) + scale_color_manual(values = my_colors))
  ggsave(filename = file.path(plot_dir, paste0('coef_non_epigenetic_', this_event, '.pdf')), width = 9, height = 6)
  print(ggplot(rank_dt[feature != '(Intercept)' & this_event==`Event Type` & alpha == 'OLS' & region != 'Gene-Wide' & mark != 'Width'], aes(x = `Samples, Features`, y = coefs, color=`PSI Variance`, shape = `Samples, Features`, size = abs(coefs))) + facet_grid(region ~ mark) + geom_hline(yintercept = 0) + geom_point() + theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())#just_text(angle = 45, hjust=1))
    + labs(y = 'Coefficient', size = 'Absolute Coefficient') + scale_shape_manual(values = LETTERS) + scale_color_manual(values = my_colors))
  ggsave(filename = file.path(plot_dir, paste0('coef_region_', this_event, '.pdf')), width =9, height = 15)
  
  # print((ggplot(rank_dt[feature != '(Intercept)' & this_event == `Event Type` & alpha == 'OLS' & explanatory == 'all' & dataset == 'all'], aes(x = reorder(mark, mark, function(x) -length(x)))) + geom_bar() + labs(title=this_event)) +
  #         (ggplot(rank_dt[feature != '(Intercept)' & this_event == `Event Type` & alpha == 'OLS' & explanatory == 'all' & dataset == 'all'], aes(x = reorder(region, region, function(x) -length(x)))) + geom_bar()))
}

```

# make roc_curves for total models:
```{r, fig.height=5, fig.width=11.7}
library(pROC)
library(patchwork)
cm_list <- sapply(to_analyze, function(this_event){
  models <- all_models[, this_event]
  as_list <- sapply(names(models)[endsWith(names(models), 'binomial')], function(cvfit_name) {
      print(paste(this_event, cvfit_name))
      cvfits <- models[[cvfit_name]]$cvfit
      test_data <- models[[cvfit_name]]$test_data
      explanatory <- models[[cvfit_name]]$explanatory
      sapply(names(cvfits), function(alpha){
        cvfit <- cvfits[[alpha]]
        if (alpha == 'OLS')
        {
          predicted <-
            predict(cvfit, newdata = test_data[, ..explanatory])
          predicted_label <- predict(cvfit, newdata = test_data[, ..explanatory], type = 'response')
          predicted_label[predicted_label < .5] <- 0
          predicted_label[predicted_label >= .5] <- 1
        }
        else
        {
          predicted <-
            predict(cvfit, newx = as.matrix(test_data[, ..explanatory]), s = my_lambda)[, 1]
          predicted_label <- predict(cvfit, newx = as.matrix(test_data[, ..explanatory]), s = my_lambda, type = 'class')[, 1]
        }
        trues <- as.factor(test_data[, binary])
      list(roc=roc(trues, predicted, levels=base::levels(as.factor(trues)),direction='<'), cm = caret::confusionMatrix(as.factor(predicted_label), trues, positive='1'))
      }, simplify = FALSE)
  }, simplify = FALSE)
  flat_as_list <- unlist(unlist(as_list, recursive = FALSE), recursive = FALSE)
  names(flat_as_list) <- gsub('nocCRE', 'wo/ cCRE', names(flat_as_list), fixed = TRUE)
  for (alpha in names(models[[1]]$cvfit)) {
    roc_list <- flat_as_list[endsWith(names(flat_as_list), paste0(alpha, '.roc'))]
    roc_list <- roc_list[order(names(roc_list))]
    auc_list <- sapply(names(roc_list), function(x){
      var <- tstrsplit(x, '_', fixed = TRUE, keep = 1)[[1]]
      paste0(var, ': ', round(roc_list[[x]][["auc"]], 2))
    })
    plot_list <- lapply(unique(tstrsplit(names(roc_list), '.', fixed=TRUE, keep=1)[[1]]), function(var) {
      tmp_roc_list <- roc_list[startsWith(names(roc_list), var)]
      
      names(tmp_roc_list) <- gsub(paste0('_binomial\\.', alpha, '\\.roc$'), '', gsub(paste0('^',var,'\\.'), '', names(tmp_roc_list)))
      p <- ggroc(tmp_roc_list) + geom_abline(intercept = 1, slope = 1,
                color = "darkgrey", linetype = "dashed") +
            labs(title=tstrsplit(var, '_', fixed = TRUE, keep = 1)[[1]], color='Samples, Features (variance: AUC)', x = 'Specificity', y = 'Sensitivity') + 
            scale_color_discrete(labels=sapply(names(tmp_roc_list), function(x) paste0(sub('_', ', ', x, fixed = TRUE), ' (', paste(auc_list[grep(x, names(auc_list), fixed = TRUE)], collapse = ', '), ')'))) + 
            theme_bw() + theme(legend.position = 'bottom') + guides(color=guide_legend(nrow=4))
      p
    })
  print(Reduce(`+`, plot_list)+ plot_layout(guides = "collect") & theme(legend.position = 'bottom'))# + plot_layout(guides = "collect") & theme(legend.position = 'bottom'))
  ggsave(filename = file.path(plot_dir, paste0('roc_', this_event, '_', alpha, '.pdf')), width = 11.7, height = 5)
    # print(ggroc(roc_list) + 
          # labs(title=paste(this_event, alpha), color='data_explanatory_response_alpha') + scale_color_discrete(labels=paste(names(roc_list), sapply(roc_list, function(x) paste0('(', round(x[["auc"]], 2),')')))) + theme_bw())
  }
  
  flat_as_list[endsWith(names(flat_as_list), '.cm')]
}, simplify = FALSE)

```
 