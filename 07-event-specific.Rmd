---
title: "ML"
output: pdf_document
---

```{r}
library(ggplot2)
library(glmnet)
glmnet.control(itrace = 1)
```


# event-specific models
```{r, fig.width=20, fig.height=10}
load('aggregating.rda')
cCREs <- data.table::fread('data/GRCh38-cCREs.bed')
names(cCREs) <- c('seqnames', 'start', 'end', 'some_id', 'accession', 'cCRE_type')

event_models <- readRDS('event_models.rds')
nsamples_dt <- rbindlist(sapply(event_models, function(event) list(nsamples=event$nsamples), simplify = FALSE), idcol='ID')
ids_with_big_nsamples <- nsamples_dt[nsamples >= 200, as.integer(ID)]
coef_dt <- rbindlist(sapply(event_models, function(cvfits){
  if (inherits(cvfits, 'simpleError'))
    return(NULL)
  coefs <- coef(summary(cvfits$cvfit$OLS))
  if (ncol(coefs) != 4) stop('something did not work')
  data.table(feature = rownames(coefs), coefs = coefs[, 1], pvalue = coefs[, 4])
  # rbindlist(sapply(names(cvfits), function(alpha) {
  #   cvfit <- cvfits[[alpha]]
  #   if (alpha == 'OLS') {
  #     coefs <- as.matrix(coef(cvfit))
  #   } else {
  #     coefs <- coef(cvfit, s = "lambda.1se")
  #   }
  #   data.table(feature = rownames(coefs), coefs = coefs[, 1])
  # }, simplify = FALSE), idcol = 'alpha')
}, simplify = FALSE), idcol='ID')
# coef_dt[, padj_ID:=p.adjust(pvalue, 'BH'), by=ID]
coef_dt[, padj:=p.adjust(pvalue, 'BH')]
coef_dt[, padj_BF:=p.adjust(pvalue, 'bonferroni')]
coef_dt[, ID:=as.integer(ID)]
coef_dt[event_dt, on=.(ID), event_name:=event_name]
# coef_dt[, coef_rank:=rank(-coefs), by=.(ID)]
coef_dt[, feature:=gsub('`', '', feature, fixed = TRUE)]
coef_dt[, cCRE_id := as.integer(gsub('^.+_(\\d+)$', '\\1', feature))]
coef_dt[, c('cCRE_type', 'cCRE_accession'):=cCREs[cCRE_id, .(cCRE_type, accession)]]
coef_dt[, mark:=tstrsplit(feature, ';', fixed = TRUE, keep = 1)]
coef_dt[!is.na(cCRE_type), feature := paste(tstrsplit(feature, '_', fixed = TRUE, keep = 1)[[1]], cCRE_type, sep = ';')]
coef_dt[is.na(cCRE_type), cCRE_type:='no_cCRE']
coef_dt[, cCRE_type:=as.factor(cCRE_type)]
ggplot(coef_dt[padj < .05], aes(y = coefs, x = tidytext::reorder_within(feature, -coefs, event_name, median), color = event_name))  + geom_boxplot() + #geom_jitter() + 
  labs(x='feature', title = 'nonzero coeffficients for each event with an enhancer in 5kb window') + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust = .5)) + tidytext::scale_x_reordered() + facet_wrap(~ event_name, scales='free', nrow = 2)
ggplot(coef_dt[padj < .05]#feature != '(Intercept)' & ID %in% coef_dt[!is.na(cCRE_type), ID]
       , aes(x = coefs, color = mark)) + geom_density() + theme_bw() + theme(axis.text.x = element_text(
         angle = 90,
         hjust = 1,
         vjust = .5
       )) + facet_wrap(~ event_name + cCRE_type, nrow = 2, scales = 'free_y')
ggplot(coef_dt[padj < .05],
       aes(
         y = coefs,
         x = tidytext::reorder_within(mark,-coefs, list(event_name, cCRE_type), median)
       ))  + geom_boxplot() + #geom_jitter() +
  labs(x = 'feature', title = 'nonzero coeffficients for each event with an enhancer in 5kb window') + theme_bw() + theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = .5
  )) + tidytext::scale_x_reordered() + facet_wrap(
    ~ event_name + cCRE_type,
    nrow = 2,
    scales = 'free',
    drop = FALSE
  )
```


```{r}
nonzero_cCRE_accessions <- coef_dt[, unique(cCRE_accession)]
fileConn<-file("nonzero_cCRE_accessions.txt")
writeLines(nonzero_cCRE_accessions, fileConn)
close(fileConn)

if (!file.exists('tf_dt.csv'))
  source('07-event-specific-get-tf.R')
```

```{r, fig.width=20, fig.height=20}
tf_dt <- fread('tf_dt.csv')
tf_dt[, percentage:=n/total]
# tfs_by_accession <- tf_dt[, list(tfs = list(name)), by=.(accession)]
# coef_dt[alpha == '1' & coefs != 0 & feature != '(Intercept)' & ID %in% coef_dt[!is.na(cCRE_type), ID]]
# coef_dt[tfs_by_accession, on=c(cCRE_accession='accession'), tfs:=tfs]
cols_to_tf <- c('coefs', 'event_name', 'cCRE_type', 'mark', 'padj', 'padj_BF')
tf_dt[coef_dt[padj < .05], on=c(accession='cCRE_accession'), (cols_to_tf):=mget(cols_to_tf)]

ggplot(tf_dt[n> 1 & cCRE_type == 'dELS' & event_name == 'SE'], aes(x = name, y = coefs)) + geom_boxplot() + facet_wrap(~ mark, ncol = 1, scales = 'free_y') + theme_bw() + theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = .5
  ))
```

```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
library(GO.db)
protein_id <- 'SYMBOL'
# first get splicing factors
go_id_splicing <- AnnotationDbi::select(GO.db, keys = c("mRNA splicing, via spliceosome"), columns = c("GOID"), keytype = c("TERM"))$GOID
splicing_factors <- unique(AnnotationDbi::select(org.Hs.eg.db, keys=go_id_splicing, columns = protein_id, keytype = "GOALL")[[protein_id]])
# here we manually produced data/splicing_factor_mapping.tab

# now get tfs
go_id_transcription_factor <- AnnotationDbi::select(GO.db, keys = c("DNA-binding transcription factor activity"), columns = c("GOID"), keytype = c("TERM"))$GOID
transcription_factors <- unique(AnnotationDbi::select(org.Hs.eg.db, keys=go_id_transcription_factor, columns = protein_id, keytype = "GOALL")[[protein_id]])
# here we manually produced data/transcription_factor_mapping.tab
```

```{r, fig.width=10, eval=FALSE}
#, fig.width=15, fig.height=10}
#, fig.height=35, fig.width=14}
non_zero_enhancers_wo_gene_expr <- coef_dt[ID %in% ids_non_zero_enhancers & !ID %in% gene_expr_ids & coefs != 0 & feature != '(Intercept)']
print(paste(non_zero_enhancers_wo_gene_expr[, uniqueN(ID)], 'events left'))

all_features <- coef_dt[, unique(feature)]
enhancer_ids <- grep('enhancer', all_features, fixed = TRUE)
ggplot(non_zero_enhancers_wo_gene_expr, aes(y = coefs, x = factor(feature, levels = c(all_features[enhancer_ids], all_features[-enhancer_ids])), color = event_name))  + geom_boxplot() + geom_jitter()+ labs(x='feature', title = 'nonzero coeffficients for each event with an enhancer in 5kb window and > 300 samples') + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust = .5)) #+ facet_wrap(~ ID, scales='free_x')
```

```{r, eval=FALSE}
all.equal(event_dt[ID %in% non_zero_enhancers_wo_gene_expr[, unique(ID)]], event_dt[non_zero_enhancers_wo_gene_expr[, sort(unique(ID))]])
event_dt[non_zero_enhancers_wo_gene_expr[, sort(unique(ID))], 'gene_id']
event_gr[non_zero_enhancers_wo_gene_expr[, sort(unique(ID))]]
enhancers <- rtracklayer::import('data/F5.hg38.enhancers.bed')
enhancer_hits <- findOverlaps(event_gr, enhancers, maxgap = 5000, ignore.strand=TRUE)
enhancers[to(enhancer_hits[from(enhancer_hits) %in% non_zero_enhancers_wo_gene_expr[, unique(ID)]])]
enhancer_hits[from(enhancer_hits) == 719]
head(enhancers)
```

